<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة الإدارة</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>إضافة منتج</h1>
    <form id="productForm">
      <label>التصنيف الأساسي:</label>
      <select id="mainCategory" required></select>

      <label>التصنيف الفرعي:</label>
      <select id="subCategory" required></select>

      <label>البراند:</label>
      <input type="text" id="brand" required />

      <label>الموديل:</label>
      <input type="text" id="model" required />

      <label>كود المصنع:</label>
      <input type="text" id="factoryCode" required />

      <label>كود SAP:</label>
      <input type="text" id="sapCode" required />

      <label>رابط الصورة:</label>
      <input type="text" id="imageUrl" placeholder="https://... أو assets/products/WC/xyz.webp" />

      <button type="submit">إضافة المنتج</button>
      <p id="message"></p>
    </form>
  </div>

  <script src="categories-data.js"></script>
  <script>
    // تعبئة التصنيفات من categories-data.js
    const mainCategorySelect = document.getElementById("mainCategory");
    const subCategorySelect = document.getElementById("subCategory");

    categories.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat.name;
      opt.textContent = cat.name;
      mainCategorySelect.appendChild(opt);
    });

    mainCategorySelect.addEventListener("change", () => {
      const selected = categories.find(c => c.name === mainCategorySelect.value);
      subCategorySelect.innerHTML = "";
      if (selected) {
        selected.subcategories.forEach(sub => {
          const opt = document.createElement("option");
          opt.value = sub;
          opt.textContent = sub;
          subCategorySelect.appendChild(opt);
        });
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      if (categories.length > 0) {
        mainCategorySelect.value = categories[0].name;
        mainCategorySelect.dispatchEvent(new Event("change"));
      }
    });

    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDmUg1cQ4HTa0wEThuZAncYOwyZRFtnlsU",
      authDomain: "projects-catalog.firebaseapp.com",
      projectId: "projects-catalog",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // إضافة منتج عند إرسال النموذج
    const form = document.getElementById("productForm");
    const msg = document.getElementById("message");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const cat = mainCategorySelect.value;
      const sub = subCategorySelect.value;
      const brand = document.getElementById("brand").value;
      const model = document.getElementById("model").value;
      const factory = document.getElementById("factoryCode").value;
      const sap = document.getElementById("sapCode").value;
      const imageUrl = document.getElementById("imageUrl").value;
      const path = `${cat} - ${sub}`;

      try {
        const id = `${cat}-${sub}-${Date.now()}`;
        await db.collection("products").doc(id).set({
          cat, sub, path,
          brand, model,
          factoryCode: factory,
          sapCode: sap,
          imageUrl,
          sap: sap,
          factory: factory,
          photo: imageUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        msg.textContent = "✔ تم حفظ المنتج بنجاح";
        msg.style.color = "green";
        form.reset();
        mainCategorySelect.dispatchEvent(new Event("change"));
      } catch (error) {
        msg.textContent = "خطأ: " + error.message;
        msg.style.color = "red";
      }
    });
  </script>
</body>
</html>
